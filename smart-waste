#!/usr/bin/env python3
"""
FIXED SMART WASTE MANAGEMENT WEB PLATFORM
Corrected database fields and HTML attribute issues
"""

import os
import json
import hashlib
import secrets
import threading
from datetime import datetime, timedelta
from http.server import HTTPServer, BaseHTTPRequestHandler
from urllib.parse import urlparse, parse_qs
import mimetypes

# MySQL support (requires: pip install mysql-connector-python)
try:
    import mysql.connector
    from mysql.connector import pooling
    MYSQL_AVAILABLE = True
except ImportError:
    MYSQL_AVAILABLE = False
    print("âš ï¸  MySQL not available. Install with: pip install mysql-connector-python")

# ============================================
# DATABASE MANAGER - FIXED FIELD ISSUES
# ============================================
class DatabaseManager:
    def __init__(self, use_mysql=True, mysql_config=None):
        self.use_mysql = use_mysql and MYSQL_AVAILABLE
        self.mysql_config = mysql_config or {
            'host': 'localhost',
            'user': 'root',
            'password': 'ghost',  # Add your MySQL password
            'database': 'smart_waste_dbbb',
            'pool_name': 'waste_pool',
            'pool_size': 10
        }
        self.local = threading.local()
        
        if self.use_mysql:
            self.init_mysql_database()
        else:
            self.init_sqlite_database()
    
    def get_connection(self):
        """Get database connection (thread-safe)"""
        if not hasattr(self.local, 'connection'):
            if self.use_mysql:
                try:
                    self.local.connection = mysql.connector.connect(**self.mysql_config)
                except mysql.connector.Error as err:
                    print(f"MySQL Error: {err}")
                    # Fallback to SQLite
                    self.use_mysql = False
                    return self.get_sqlite_connection()
            else:
                self.local.connection = self.get_sqlite_connection()
        return self.local.connection
    
    def get_sqlite_connection(self):
        """Fallback SQLite connection"""
        import sqlite3
        conn = sqlite3.connect('smart_waste.db', check_same_thread=False)
        conn.row_factory = sqlite3.Row
        return conn
    
    def init_mysql_database(self):
        """Initialize MySQL database with all tables"""
        try:
            # First, create database if not exists (without pool)
            conn = mysql.connector.connect(
                host=self.mysql_config['host'],
                user=self.mysql_config['user'],
                password=self.mysql_config['password']
            )
            cursor = conn.cursor()
            cursor.execute(f"CREATE DATABASE IF NOT EXISTS {self.mysql_config['database']}")
            conn.close()
            
            # Now connect to the database and create tables
            conn = self.get_connection()
            cursor = conn.cursor()
            
            # Users table
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    username VARCHAR(50) UNIQUE NOT NULL,
                    email VARCHAR(100) UNIQUE NOT NULL,
                    password_hash VARCHAR(64) NOT NULL,
                    full_name VARCHAR(100),
                    phone VARCHAR(20),
                    address TEXT,
                    city VARCHAR(50),
                    is_admin BOOLEAN DEFAULT FALSE,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    last_login TIMESTAMP NULL,
                    INDEX idx_username (username),
                    INDEX idx_email (email)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ''')
            
            # Waste categories
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS waste_categories (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    name VARCHAR(50) NOT NULL,
                    description TEXT,
                    color_code VARCHAR(7) DEFAULT '#4CAF50',
                    icon VARCHAR(10) DEFAULT 'ðŸ—‘ï¸',
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ''')
            
            # Waste reports
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS waste_reports (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    user_id INT NOT NULL,
                    category_id INT NOT NULL,
                    location_name VARCHAR(200) NOT NULL,
                    latitude DECIMAL(10, 8),
                    longitude DECIMAL(11, 8),
                    address TEXT,
                    description TEXT NOT NULL,
                    status ENUM('reported', 'assigned', 'collected', 'processed') DEFAULT 'reported',
                    urgency ENUM('low', 'medium', 'high') DEFAULT 'medium',
                    image_url VARCHAR(500),
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                    collected_at TIMESTAMP NULL,
                    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                    FOREIGN KEY (category_id) REFERENCES waste_categories(id) ON DELETE CASCADE,
                    INDEX idx_status (status),
                    INDEX idx_urgency (urgency),
                    INDEX idx_created (created_at)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ''')
            
            # Collection schedules
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS collection_schedules (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    report_id INT NOT NULL,
                    assigned_to INT,
                    scheduled_date DATE NOT NULL,
                    scheduled_time TIME,
                    status ENUM('pending', 'in_progress', 'completed', 'cancelled') DEFAULT 'pending',
                    notes TEXT,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    completed_at TIMESTAMP NULL,
                    FOREIGN KEY (report_id) REFERENCES waste_reports(id) ON DELETE CASCADE,
                    FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL,
                    INDEX idx_scheduled_date (scheduled_date),
                    INDEX idx_status (status)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ''')
            
            # Status history
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS status_history (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    report_id INT NOT NULL,
                    old_status VARCHAR(50),
                    new_status VARCHAR(50) NOT NULL,
                    changed_by INT,
                    notes TEXT,
                    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (report_id) REFERENCES waste_reports(id) ON DELETE CASCADE,
                    FOREIGN KEY (changed_by) REFERENCES users(id) ON DELETE SET NULL,
                    INDEX idx_report_id (report_id),
                    INDEX idx_changed_at (changed_at)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ''')
            
            # Password reset tokens
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS password_reset_tokens (
                    id INT AUTO_INCREMENT PRIMARY KEY,
                    user_id INT NOT NULL,
                    token VARCHAR(64) UNIQUE NOT NULL,
                    expires_at TIMESTAMP NOT NULL,
                    used BOOLEAN DEFAULT FALSE,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                    INDEX idx_token (token),
                    INDEX idx_expires (expires_at)
                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
            ''')
            
            # Insert default categories
            categories = [
                ('Plastic', 'Plastic bottles, bags, packaging', '#2196F3', 'ðŸ¥¤'),
                ('Organic', 'Food waste, garden waste', '#4CAF50', 'ðŸŒ¿'),
                ('Electronic', 'E-waste, batteries, electronics', '#FF9800', 'ðŸ”Œ'),
                ('Paper', 'Paper, cardboard, newspapers', '#FFC107', 'ðŸ“„'),
                ('Glass', 'Glass bottles, jars', '#00BCD4', 'ðŸ¥ƒ'),
                ('Metal', 'Metal cans, scrap metal', '#795548', 'ðŸ¥«'),
                ('Hazardous', 'Chemicals, medical waste', '#F44336', 'âš ï¸'),
                ('Construction', 'Construction debris', '#9E9E9E', 'ðŸ—ï¸'),
                ('Other', 'Uncategorized waste', '#607D8B', 'ðŸ—‘ï¸')
            ]
            
            for name, desc, color, icon in categories:
                cursor.execute('''
                    INSERT IGNORE INTO waste_categories (name, description, color_code, icon)
                    VALUES (%s, %s, %s, %s)
                ''', (name, desc, color, icon))
            
            # Create admin user
            admin_hash = hashlib.sha256('Admin@2024'.encode()).hexdigest()
            cursor.execute('''
                INSERT IGNORE INTO users (username, email, password_hash, full_name, is_admin)
                VALUES (%s, %s, %s, %s, %s)
            ''', ('admin', 'admin@smartwaste.com', admin_hash, 'System Administrator', True))
            
            # Create demo user
            user_hash = hashlib.sha256('User@2024'.encode()).hexdigest()
            cursor.execute('''
                INSERT IGNORE INTO users (username, email, password_hash, full_name, city, is_admin)
                VALUES (%s, %s, %s, %s, %s, %s)
            ''', ('john_doe', 'john@example.com', user_hash, 'John Doe', 'New York', False))
            
            conn.commit()
            print("âœ… MySQL database initialized successfully!")
            
        except mysql.connector.Error as err:
            print(f"âŒ MySQL Error: {err}")
            print("ðŸ” Falling back to SQLite...")
            self.use_mysql = False
            self.init_sqlite_database()
    
    def init_sqlite_database(self):
        """Fallback SQLite initialization"""
        import sqlite3
        
        conn = sqlite3.connect('smart_waste.db', check_same_thread=False)
        conn.row_factory = sqlite3.Row
        cursor = conn.cursor()
        
        # Create tables (SQLite version)
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                username TEXT UNIQUE NOT NULL,
                email TEXT UNIQUE NOT NULL,
                password_hash TEXT NOT NULL,
                full_name TEXT,
                phone TEXT,
                address TEXT,
                city TEXT,
                is_admin BOOLEAN DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_login TIMESTAMP
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS waste_categories (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                description TEXT,
                color_code TEXT DEFAULT '#4CAF50',
                icon TEXT DEFAULT 'ðŸ—‘ï¸',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS waste_reports (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                category_id INTEGER NOT NULL,
                location_name TEXT NOT NULL,
                latitude REAL,
                longitude REAL,
                address TEXT,
                description TEXT NOT NULL,
                status TEXT DEFAULT 'reported' CHECK(status IN ('reported', 'assigned', 'collected', 'processed')),
                urgency TEXT DEFAULT 'medium' CHECK(urgency IN ('low', 'medium', 'high')),
                image_url TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                collected_at TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
                FOREIGN KEY (category_id) REFERENCES waste_categories(id) ON DELETE CASCADE
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS collection_schedules (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                report_id INTEGER NOT NULL,
                assigned_to INTEGER,
                scheduled_date DATE NOT NULL,
                scheduled_time TEXT,
                status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'in_progress', 'completed', 'cancelled')),
                notes TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                completed_at TIMESTAMP,
                FOREIGN KEY (report_id) REFERENCES waste_reports(id) ON DELETE CASCADE,
                FOREIGN KEY (assigned_to) REFERENCES users(id) ON DELETE SET NULL
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS status_history (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                report_id INTEGER NOT NULL,
                old_status TEXT,
                new_status TEXT NOT NULL,
                changed_by INTEGER,
                notes TEXT,
                changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (report_id) REFERENCES waste_reports(id) ON DELETE CASCADE,
                FOREIGN KEY (changed_by) REFERENCES users(id) ON DELETE SET NULL
            )
        ''')
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS password_reset_tokens (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                token TEXT UNIQUE NOT NULL,
                expires_at TIMESTAMP NOT NULL,
                used BOOLEAN DEFAULT FALSE,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
            )
        ''')
        
        # Insert default data
        categories = [
            ('Plastic', 'Plastic bottles, bags, packaging', '#2196F3', 'ðŸ¥¤'),
            ('Organic', 'Food waste, garden waste', '#4CAF50', 'ðŸŒ¿'),
            ('Electronic', 'E-waste, batteries, electronics', '#FF9800', 'ðŸ”Œ'),
            ('Paper', 'Paper, cardboard, newspapers', '#FFC107', 'ðŸ“„'),
            ('Glass', 'Glass bottles, jars', '#00BCD4', 'ðŸ¥ƒ'),
            ('Metal', 'Metal cans, scrap metal', '#795548', 'ðŸ¥«'),
            ('Hazardous', 'Chemicals, medical waste', '#F44336', 'âš ï¸'),
            ('Construction', 'Construction debris', '#9E9E9E', 'ðŸ—ï¸'),
            ('Other', 'Uncategorized waste', '#607D8B', 'ðŸ—‘ï¸')
        ]
        
        for name, desc, color, icon in categories:
            cursor.execute('''
                INSERT OR IGNORE INTO waste_categories (name, description, color_code, icon)
                VALUES (?, ?, ?, ?)
            ''', (name, desc, color, icon))
        
        # Create admin user
        admin_hash = hashlib.sha256('Admin@2024'.encode()).hexdigest()
        cursor.execute('''
            INSERT OR IGNORE INTO users (username, email, password_hash, full_name, is_admin)
            VALUES (?, ?, ?, ?, ?)
        ''', ('admin', 'admin@smartwaste.com', admin_hash, 'System Administrator', 1))
        
        # Create demo user
        user_hash = hashlib.sha256('User@2024'.encode()).hexdigest()
        cursor.execute('''
            INSERT OR IGNORE INTO users (username, email, password_hash, full_name, city, is_admin)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', ('john_doe', 'john@example.com', user_hash, 'John Doe', 'New York', 0))
        
        conn.commit()
        print("âœ… SQLite database initialized successfully!")
    
    # FIXED: Added missing create_user method
    def create_user(self, username, email, password_hash, full_name='', phone='', address='', city='', is_admin=False):
        """Create a new user"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        try:
            if self.use_mysql:
                cursor.execute('''
                    INSERT INTO users (username, email, password_hash, full_name, phone, address, city, is_admin)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                ''', (username, email, password_hash, full_name, phone, address, city, is_admin))
            else:
                cursor.execute('''
                    INSERT INTO users (username, email, password_hash, full_name, phone, address, city, is_admin)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ''', (username, email, password_hash, full_name, phone, address, city, is_admin))
            
            user_id = cursor.lastrowid
            conn.commit()
            return user_id
        except Exception as e:
            print(f"Error creating user: {e}")
            conn.rollback()
            return None
    
    # FIXED: Corrected field references in queries
    def get_all_reports(self, user_id=None, status=None, category_id=None, assigned_to=None):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # FIXED: Corrected field references - removed 'icon' and fixed table joins
        if self.use_mysql:
            query = '''
                SELECT wr.*, u.username, u.full_name, u.email, 
                       wc.name as category_name, wc.description as category_description,
                       wc.color_code, wc.icon,
                       (SELECT COUNT(*) FROM collection_schedules cs WHERE cs.report_id = wr.id) as schedule_count
                FROM waste_reports wr
                JOIN users u ON u.id = wr.user_id
                JOIN waste_categories wc ON wc.id = wr.category_id
                WHERE 1=1
            '''
        else:
            query = '''
                SELECT wr.*, u.username, u.full_name, u.email, 
                       wc.name as category_name, wc.description as category_description,
                       wc.color_code, wc.icon,
                       (SELECT COUNT(*) FROM collection_schedules cs WHERE cs.report_id = wr.id) as schedule_count
                FROM waste_reports wr
                JOIN users u ON u.id = wr.user_id
                JOIN waste_categories wc ON wc.id = wr.category_id
                WHERE 1=1
            '''
        
        params = []
        
        if user_id:
            user = self.get_user_by_id(user_id)
            if not user['is_admin']:
                query += ' AND wr.user_id = %s' if self.use_mysql else ' AND wr.user_id = ?'
                params.append(user_id)
        
        if status:
            query += ' AND wr.status = %s' if self.use_mysql else ' AND wr.status = ?'
            params.append(status)
        
        if category_id:
            query += ' AND wr.category_id = %s' if self.use_mysql else ' AND wr.category_id = ?'
            params.append(category_id)
        
        if assigned_to:
            if self.use_mysql:
                query += ''' AND wr.id IN (
                    SELECT DISTINCT cs.report_id 
                    FROM collection_schedules cs 
                    WHERE cs.assigned_to = %s AND cs.status != 'completed'
                )'''
            else:
                query += ''' AND wr.id IN (
                    SELECT DISTINCT cs.report_id 
                    FROM collection_schedules cs 
                    WHERE cs.assigned_to = ? AND cs.status != 'completed'
                )'''
            params.append(assigned_to)
        
        query += ' ORDER BY wr.created_at DESC'
        
        try:
            cursor.execute(query, params)
            if self.use_mysql:
                columns = [col[0] for col in cursor.description]
                reports = [dict(zip(columns, row)) for row in cursor.fetchall()]
            else:
                reports = [dict(row) for row in cursor.fetchall()]
            return reports
        except Exception as e:
            print(f"Database query error: {e}")
            print(f"Query: {query}")
            print(f"Params: {params}")
            return []
    
    # FIXED: Corrected field references in get_report_by_id
    def get_report_by_id(self, report_id, user_id=None):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # FIXED: Corrected field references
        if self.use_mysql:
            query = '''
                SELECT wr.*, u.username, u.full_name, u.email, u.phone, u.address, u.city,
                       wc.name as category_name, wc.description as category_description,
                       wc.color_code, wc.icon
                FROM waste_reports wr
                JOIN users u ON u.id = wr.user_id
                JOIN waste_categories wc ON wc.id = wr.category_id
                WHERE wr.id = %s
            '''
        else:
            query = '''
                SELECT wr.*, u.username, u.full_name, u.email, u.phone, u.address, u.city,
                       wc.name as category_name, wc.description as category_description,
                       wc.color_code, wc.icon
                FROM waste_reports wr
                JOIN users u ON u.id = wr.user_id
                JOIN waste_categories wc ON wc.id = wr.category_id
                WHERE wr.id = ?
            '''
        
        params = [report_id]
        
        if user_id:
            user = self.get_user_by_id(user_id)
            if not user['is_admin']:
                query += ' AND wr.user_id = %s' if self.use_mysql else ' AND wr.user_id = ?'
                params.append(user_id)
        
        try:
            cursor.execute(query, params)
            
            if self.use_mysql:
                columns = [col[0] for col in cursor.description]
                result = cursor.fetchone()
                report = dict(zip(columns, result)) if result else None
            else:
                report = dict(cursor.fetchone()) if cursor.fetchone() else None
            
            if report:
                # Get status history
                if self.use_mysql:
                    cursor.execute('''
                        SELECT sh.*, u.username as changed_by_name
                        FROM status_history sh
                        LEFT JOIN users u ON u.id = sh.changed_by
                        WHERE sh.report_id = %s
                        ORDER BY sh.changed_at DESC
                    ''', (report_id,))
                    columns = [col[0] for col in cursor.description]
                    history = [dict(zip(columns, row)) for row in cursor.fetchall()]
                else:
                    cursor.execute('''
                        SELECT sh.*, u.username as changed_by_name
                        FROM status_history sh
                        LEFT JOIN users u ON u.id = sh.changed_by
                        WHERE sh.report_id = ?
                        ORDER BY sh.changed_at DESC
                    ''', (report_id,))
                    history = [dict(row) for row in cursor.fetchall()]
                
                # Get schedules
                if self.use_mysql:
                    cursor.execute('''
                        SELECT cs.*, u.full_name as assigned_to_name
                        FROM collection_schedules cs
                        LEFT JOIN users u ON u.id = cs.assigned_to
                        WHERE cs.report_id = %s
                        ORDER BY cs.scheduled_date DESC, cs.scheduled_time DESC
                    ''', (report_id,))
                    columns = [col[0] for col in cursor.description]
                    schedules = [dict(zip(columns, row)) for row in cursor.fetchall()]
                else:
                    cursor.execute('''
                        SELECT cs.*, u.full_name as assigned_to_name
                        FROM collection_schedules cs
                        LEFT JOIN users u ON u.id = cs.assigned_to
                        WHERE cs.report_id = ?
                        ORDER BY cs.scheduled_date DESC, cs.scheduled_time DESC
                    ''', (report_id,))
                    schedules = [dict(row) for row in cursor.fetchall()]
                
                result = report
                result['history'] = history
                result['schedules'] = schedules
            else:
                result = None
            
            return result
        except Exception as e:
            print(f"Database query error in get_report_by_id: {e}")
            return None
    
    def get_user_by_username(self, username):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('SELECT * FROM users WHERE username = %s', (username,))
            columns = [col[0] for col in cursor.description]
            result = cursor.fetchone()
            user = dict(zip(columns, result)) if result else None
        else:
            cursor.execute('SELECT * FROM users WHERE username = ?', (username,))
            user = dict(cursor.fetchone()) if cursor.fetchone() else None
        
        return user
    
    def get_user_by_id(self, user_id):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('SELECT * FROM users WHERE id = %s', (user_id,))
            columns = [col[0] for col in cursor.description]
            result = cursor.fetchone()
            user = dict(zip(columns, result)) if result else None
        else:
            cursor.execute('SELECT * FROM users WHERE id = ?', (user_id,))
            user = dict(cursor.fetchone()) if cursor.fetchone() else None
        
        return user
    
    def update_user_password(self, user_id, new_password_hash):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('UPDATE users SET password_hash = %s WHERE id = %s', (new_password_hash, user_id))
        else:
            cursor.execute('UPDATE users SET password_hash = ? WHERE id = ?', (new_password_hash, user_id))
        
        conn.commit()
        return True
    
    def update_last_login(self, user_id):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('UPDATE users SET last_login = NOW() WHERE id = %s', (user_id,))
        else:
            cursor.execute('UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = ?', (user_id,))
        
        conn.commit()
    
    def get_all_users(self, exclude_admin=True):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        query = 'SELECT * FROM users WHERE 1=1'
        params = []
        
        if exclude_admin:
            query += ' AND is_admin = %s' if self.use_mysql else ' AND is_admin = ?'
            params.append(0)
        
        query += ' ORDER BY created_at DESC'
        
        cursor.execute(query, params)
        
        if self.use_mysql:
            columns = [col[0] for col in cursor.description]
            users = [dict(zip(columns, row)) for row in cursor.fetchall()]
        else:
            users = [dict(row) for row in cursor.fetchall()]
        
        return users
    
    def get_collection_staff(self):
        """Get all users who can be assigned to collections (non-admin users)"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('SELECT id, username, full_name FROM users WHERE is_admin = %s ORDER BY full_name', (0,))
            columns = [col[0] for col in cursor.description]
            staff = [dict(zip(columns, row)) for row in cursor.fetchall()]
        else:
            cursor.execute('SELECT id, username, full_name FROM users WHERE is_admin = ? ORDER BY full_name', (0,))
            staff = [dict(row) for row in cursor.fetchall()]
        
        return staff
    
    def create_waste_report(self, user_id, category_id, location_name, description, urgency='medium', address=''):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('''
                INSERT INTO waste_reports (user_id, category_id, location_name, description, urgency, address)
                VALUES (%s, %s, %s, %s, %s, %s)
            ''', (user_id, category_id, location_name, description, urgency, address))
        else:
            cursor.execute('''
                INSERT INTO waste_reports (user_id, category_id, location_name, description, urgency, address)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (user_id, category_id, location_name, description, urgency, address))
        
        report_id = cursor.lastrowid
        
        # Record initial status
        if self.use_mysql:
            cursor.execute('''
                INSERT INTO status_history (report_id, old_status, new_status, changed_by)
                VALUES (%s, %s, %s, %s)
            ''', (report_id, None, 'reported', user_id))
        else:
            cursor.execute('''
                INSERT INTO status_history (report_id, old_status, new_status, changed_by)
                VALUES (?, ?, ?, ?)
            ''', (report_id, None, 'reported', user_id))
        
        conn.commit()
        return report_id
    
    def update_report_status(self, report_id, new_status, changed_by, notes=''):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # Get current status
        if self.use_mysql:
            cursor.execute('SELECT status FROM waste_reports WHERE id = %s', (report_id,))
            result = cursor.fetchone()
            old_status = result[0] if result else None
        else:
            cursor.execute('SELECT status FROM waste_reports WHERE id = ?', (report_id,))
            result = cursor.fetchone()
            old_status = result['status'] if result else None
        
        # Update report
        if self.use_mysql:
            cursor.execute('''
                UPDATE waste_reports 
                SET status = %s, updated_at = NOW(),
                    collected_at = CASE WHEN %s = 'collected' THEN NOW() ELSE collected_at END
                WHERE id = %s
            ''', (new_status, new_status, report_id))
        else:
            cursor.execute('''
                UPDATE waste_reports 
                SET status = ?, updated_at = CURRENT_TIMESTAMP,
                    collected_at = CASE WHEN ? = 'collected' THEN CURRENT_TIMESTAMP ELSE collected_at END
                WHERE id = ?
            ''', (new_status, new_status, report_id))
        
        # Record in history
        if self.use_mysql:
            cursor.execute('''
                INSERT INTO status_history (report_id, old_status, new_status, changed_by, notes)
                VALUES (%s, %s, %s, %s, %s)
            ''', (report_id, old_status, new_status, changed_by, notes))
        else:
            cursor.execute('''
                INSERT INTO status_history (report_id, old_status, new_status, changed_by, notes)
                VALUES (?, ?, ?, ?, ?)
            ''', (report_id, old_status, new_status, changed_by, notes))
        
        conn.commit()
        return True
    
    def assign_report_to_collector(self, report_id, assigned_to, scheduled_date, scheduled_time, notes=''):
        """Admin function to assign a report to a collector"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # Create collection schedule
        if self.use_mysql:
            cursor.execute('''
                INSERT INTO collection_schedules (report_id, assigned_to, scheduled_date, scheduled_time, notes)
                VALUES (%s, %s, %s, %s, %s)
            ''', (report_id, assigned_to, scheduled_date, scheduled_time, notes))
        else:
            cursor.execute('''
                INSERT INTO collection_schedules (report_id, assigned_to, scheduled_date, scheduled_time, notes)
                VALUES (?, ?, ?, ?, ?)
            ''', (report_id, assigned_to, scheduled_date, scheduled_time, notes))
        
        # Update report status to assigned
        if self.use_mysql:
            cursor.execute('UPDATE waste_reports SET status = %s WHERE id = %s', ('assigned', report_id))
        else:
            cursor.execute('UPDATE waste_reports SET status = ? WHERE id = ?', ('assigned', report_id))
        
        # Record status change
        if self.use_mysql:
            cursor.execute('''
                INSERT INTO status_history (report_id, old_status, new_status, changed_by, notes)
                VALUES (%s, %s, %s, %s, %s)
            ''', (report_id, 'reported', 'assigned', assigned_to, f"Assigned to collector for {scheduled_date}"))
        else:
            cursor.execute('''
                INSERT INTO status_history (report_id, old_status, new_status, changed_by, notes)
                VALUES (?, ?, ?, ?, ?)
            ''', (report_id, 'reported', 'assigned', assigned_to, f"Assigned to collector for {scheduled_date}"))
        
        conn.commit()
        return True
    
    def delete_report(self, report_id, user_id):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # Check ownership or admin
        if self.use_mysql:
            cursor.execute('SELECT user_id FROM waste_reports WHERE id = %s', (report_id,))
            result = cursor.fetchone()
            report_user_id = result[0] if result else None
        else:
            cursor.execute('SELECT user_id FROM waste_reports WHERE id = ?', (report_id,))
            result = cursor.fetchone()
            report_user_id = result['user_id'] if result else None
        
        user = self.get_user_by_id(user_id)
        
        if not report_user_id or (report_user_id != user_id and not user['is_admin']):
            return False
        
        if self.use_mysql:
            cursor.execute('DELETE FROM waste_reports WHERE id = %s', (report_id,))
        else:
            cursor.execute('DELETE FROM waste_reports WHERE id = ?', (report_id,))
        
        conn.commit()
        return True
    
    def get_all_categories(self):
        conn = self.get_connection()
        cursor = conn.cursor()
        cursor.execute('SELECT * FROM waste_categories ORDER BY name')
        
        if self.use_mysql:
            columns = [col[0] for col in cursor.description]
            categories = [dict(zip(columns, row)) for row in cursor.fetchall()]
        else:
            categories = [dict(row) for row in cursor.fetchall()]
        
        return categories
    
    def create_schedule(self, report_id, scheduled_date, scheduled_time, assigned_to=None, notes=''):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('''
                INSERT INTO collection_schedules (report_id, scheduled_date, scheduled_time, assigned_to, notes)
                VALUES (%s, %s, %s, %s, %s)
            ''', (report_id, scheduled_date, scheduled_time, assigned_to, notes))
        else:
            cursor.execute('''
                INSERT INTO collection_schedules (report_id, scheduled_date, scheduled_time, assigned_to, notes)
                VALUES (?, ?, ?, ?, ?)
            ''', (report_id, scheduled_date, scheduled_time, assigned_to, notes))
        
        schedule_id = cursor.lastrowid
        conn.commit()
        return schedule_id
    
    def update_schedule_status(self, schedule_id, status, completed_at=None):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('''
                UPDATE collection_schedules 
                SET status = %s, completed_at = %s
                WHERE id = %s
            ''', (status, completed_at, schedule_id))
        else:
            cursor.execute('''
                UPDATE collection_schedules 
                SET status = ?, completed_at = ?
                WHERE id = ?
            ''', (status, completed_at, schedule_id))
        
        conn.commit()
        return True
    
    def get_todays_schedules(self):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('''
                SELECT cs.*, wr.location_name, wr.description, wr.urgency,
                       u.full_name as reporter_name, wc.name as category_name
                FROM collection_schedules cs
                JOIN waste_reports wr ON wr.id = cs.report_id
                JOIN users u ON u.id = wr.user_id
                JOIN waste_categories wc ON wc.id = wr.category_id
                WHERE DATE(cs.scheduled_date) = CURDATE()
                ORDER BY cs.scheduled_time
            ''')
            columns = [col[0] for col in cursor.description]
            schedules = [dict(zip(columns, row)) for row in cursor.fetchall()]
        else:
            cursor.execute('''
                SELECT cs.*, wr.location_name, wr.description, wr.urgency,
                       u.full_name as reporter_name, wc.name as category_name
                FROM collection_schedules cs
                JOIN waste_reports wr ON wr.id = cs.report_id
                JOIN users u ON u.id = wr.user_id
                JOIN waste_categories wc ON wc.id = wr.category_id
                WHERE DATE(cs.scheduled_date) = DATE('now')
                ORDER BY cs.scheduled_time
            ''')
            schedules = [dict(row) for row in cursor.fetchall()]
        
        return schedules
    
    def get_my_schedules(self, user_id):
        """Get schedules assigned to a specific collector"""
        conn = self.get_connection()
        cursor = conn.cursor()
        
        if self.use_mysql:
            cursor.execute('''
                SELECT cs.*, wr.location_name, wr.description, wr.urgency,
                       u.full_name as reporter_name, wc.name as category_name
                FROM collection_schedules cs
                JOIN waste_reports wr ON wr.id = cs.report_id
                JOIN users u ON u.id = wr.user_id
                JOIN waste_categories wc ON wc.id = wr.category_id
                WHERE cs.assigned_to = %s AND cs.status IN ('pending', 'in_progress')
                ORDER BY cs.scheduled_date, cs.scheduled_time
            ''', (user_id,))
            columns = [col[0] for col in cursor.description]
            schedules = [dict(zip(columns, row)) for row in cursor.fetchall()]
        else:
            cursor.execute('''
                SELECT cs.*, wr.location_name, wr.description, wr.urgency,
                       u.full_name as reporter_name, wc.name as category_name
                FROM collection_schedules cs
                JOIN waste_reports wr ON wr.id = cs.report_id
                JOIN users u ON u.id = wr.user_id
                JOIN waste_categories wc ON wc.id = wr.category_id
                WHERE cs.assigned_to = ? AND cs.status IN ('pending', 'in_progress')
                ORDER BY cs.scheduled_date, cs.scheduled_time
            ''', (user_id,))
            schedules = [dict(row) for row in cursor.fetchall()]
        
        return schedules
    
    def get_statistics(self):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        # Overall stats
        cursor.execute('SELECT COUNT(*) as total FROM waste_reports')
        result = cursor.fetchone()
        total = result[0] if result else 0
        
        cursor.execute('SELECT status, COUNT(*) as count FROM waste_reports GROUP BY status')
        if self.use_mysql:
            by_status_rows = cursor.fetchall()
            by_status = {row[0]: row[1] for row in by_status_rows}
        else:
            by_status_rows = cursor.fetchall()
            by_status = {row['status']: row['count'] for row in by_status_rows}
        
        # Category distribution
        cursor.execute('''
            SELECT wc.name, COUNT(wr.id) as count
            FROM waste_categories wc
            LEFT JOIN waste_reports wr ON wr.category_id = wc.id
            GROUP BY wc.id, wc.name
            ORDER BY count DESC
        ''')
        
        if self.use_mysql:
            columns = [col[0] for col in cursor.description]
            by_category = [dict(zip(columns, row)) for row in cursor.fetchall()]
        else:
            by_category = [dict(row) for row in cursor.fetchall()]
        
        # Recent activity (last 7 days)
        if self.use_mysql:
            cursor.execute('''
                SELECT DATE(created_at) as date, COUNT(*) as count
                FROM waste_reports
                WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
                GROUP BY DATE(created_at)
                ORDER BY date
            ''')
            columns = [col[0] for col in cursor.description]
            recent_activity = [dict(zip(columns, row)) for row in cursor.fetchall()]
        else:
            cursor.execute('''
                SELECT DATE(created_at) as date, COUNT(*) as count
                FROM waste_reports
                WHERE created_at >= DATE('now', '-7 days')
                GROUP BY DATE(created_at)
                ORDER BY date
            ''')
            recent_activity = [dict(row) for row in cursor.fetchall()]
        
        # User stats
        cursor.execute('SELECT COUNT(*) as total FROM users')
        result = cursor.fetchone()
        total_users = result[0] if result else 0
        
        if self.use_mysql:
            cursor.execute('SELECT COUNT(*) as active FROM users WHERE last_login >= DATE_SUB(NOW(), INTERVAL 30 DAY)')
        else:
            cursor.execute('SELECT COUNT(*) as active FROM users WHERE last_login >= DATE("now", "-30 days")')
        
        result = cursor.fetchone()
        active_users = result[0] if result else 0
        
        # Collection rate
        collected = by_status.get('collected', 0)
        collection_rate = round((collected / total * 100) if total > 0 else 0, 1)
        
        return {
            'total_reports': total,
            'by_status': by_status,
            'by_category': by_category,
            'recent_activity': recent_activity,
            'total_users': total_users,
            'active_users': active_users,
            'collection_rate': collection_rate
        }

# ============================================
# WEB SERVER HANDLER - FIXED
# ============================================
class SmartWasteHandler(BaseHTTPRequestHandler):
    db = DatabaseManager(use_mysql=False)  # Set to True for MySQL
    sessions = {}
    
    # ========== SESSION MANAGEMENT ==========
    def generate_session_id(self):
        return secrets.token_hex(32)
    
    def get_current_user(self):
        """Get user from session cookie"""
        cookie = self.headers.get('Cookie', '')
        session_id = None
        
        for part in cookie.split(';'):
            part = part.strip()
            if part.startswith('session_id='):
                session_id = part.split('=')[1].strip()
                break
        
        if session_id and session_id in self.sessions:
            user_data = self.sessions[session_id]
            # Refresh session expiry
            self.sessions[session_id]['expires'] = datetime.now() + timedelta(hours=2)
            return user_data['user']
        
        return None
    
    # ========== REQUEST HANDLING ==========
    def do_GET(self):
        """Handle GET requests"""
        path = urlparse(self.path).path
        
        # API endpoints
        if path.startswith('/api/'):
            self.handle_api('GET')
        # Static files
        elif path.startswith('/static/'):
            self.serve_static(path[1:])
        # HTML pages
        else:
            self.serve_html(path)
    
    def do_POST(self):
        """Handle POST requests"""
        self.handle_api('POST')
    
    def do_PUT(self):
        """Handle PUT requests"""
        self.handle_api('PUT')
    
    def do_DELETE(self):
        """Handle DELETE requests"""
        self.handle_api('DELETE')
    
    # ========== FILE SERVING ==========
    def serve_static(self, filepath):
        """Serve static files (CSS, JS, images)"""
        try:
            if filepath == 'static/css/style.css':
                content = self.STYLE_CSS.encode()
                content_type = 'text/css'
            elif filepath == 'static/js/script.js':
                content = self.SCRIPT_JS.encode()
                content_type = 'application/javascript'
            elif filepath == 'static/js/chart.js':
                content = self.CHART_JS.encode()
                content_type = 'application/javascript'
            else:
                self.send_error(404, "File not found")
                return
            
            self.send_response(200)
            self.send_header('Content-Type', content_type)
            self.send_header('Content-Length', str(len(content)))
            self.end_headers()
            self.wfile.write(content)
        except Exception as e:
            self.send_error(500, f"Server error: {str(e)}")
    
    def serve_html(self, path):
        """Serve HTML pages"""
        page_map = {
            '/': 'home',
            '/index.html': 'home',
            '/login': 'login',
            '/register': 'register',
            '/dashboard': 'dashboard',
            '/report': 'report',
            '/reports': 'reports_list',
            '/report-details': 'report_details',
            '/schedules': 'schedules',
            '/my-schedules': 'my_schedules',
            '/admin': 'admin',
            '/admin/reports': 'admin_reports',
            '/admin/users': 'admin_users',
            '/admin/assign': 'admin_assign',
            '/profile': 'profile',
            '/change-password': 'change_password',
            '/about': 'about',
            '/contact': 'contact'
        }
        
        if path in page_map:
            try:
                content = self.get_html_content(page_map[path])
                self.send_response(200)
                self.send_header('Content-Type', 'text/html')
                self.send_header('Content-Length', str(len(content.encode())))
                self.end_headers()
                self.wfile.write(content.encode())
            except Exception as e:
                print(f"Error serving HTML {path}: {e}")
                self.send_error(500, f"Server error: {str(e)}")
        else:
            self.send_error(404, "Page not found")
    
    # ========== API HANDLING ==========
    def handle_api(self, method):
        """Handle API requests"""
        path = urlparse(self.path).path
        
        # Public API endpoints
        if path == '/api/login' and method == 'POST':
            self.api_login()
        elif path == '/api/register' and method == 'POST':
            self.api_register()
        elif path == '/api/categories' and method == 'GET':
            self.api_get_categories()
        elif path == '/api/stats/public' and method == 'GET':
            self.api_public_stats()
        elif path == '/api/logout' and method == 'POST':
            self.api_logout()
        else:
            # Protected endpoints
            user = self.get_current_user()
            if not user:
                self.send_json({'error': 'Authentication required'}, 401)
                return
            
            # User endpoints
            if path == '/api/user/profile' and method == 'GET':
                self.api_user_profile(user)
            elif path == '/api/user/update' and method == 'PUT':
                self.api_update_profile(user)
            elif path == '/api/user/change-password' and method == 'POST':
                self.api_change_password(user)
            
            # Report endpoints
            elif path == '/api/reports' and method == 'GET':
                self.api_get_reports(user)
            elif path == '/api/reports' and method == 'POST':
                self.api_create_report(user)
            elif path.startswith('/api/reports/') and method == 'GET':
                report_id = int(path.split('/')[-1])
                self.api_get_report(report_id, user)
            elif path.startswith('/api/reports/') and method == 'PUT':
                report_id = int(path.split('/')[-1])
                self.api_update_report(report_id, user)
            elif path.startswith('/api/reports/') and method == 'DELETE':
                report_id = int(path.split('/')[-1])
                self.api_delete_report(report_id, user)
            
            # Schedule endpoints
            elif path == '/api/schedules' and method == 'GET':
                self.api_get_schedules(user)
            elif path == '/api/schedules' and method == 'POST':
                self.api_create_schedule(user)
            elif path == '/api/my-schedules' and method == 'GET':
                self.api_get_my_schedules(user)
            elif path.startswith('/api/schedules/') and method == 'PUT':
                schedule_id = int(path.split('/')[-1])
                self.api_update_schedule(schedule_id, user)
            
            # Admin endpoints
            elif path == '/api/admin/stats' and method == 'GET':
                self.api_admin_stats(user)
            elif path == '/api/admin/users' and method == 'GET':
                self.api_get_users(user)
            elif path == '/api/admin/reports' and method == 'GET':
                self.api_admin_reports(user)
            elif path == '/api/admin/assign-report' and method == 'POST':
                self.api_assign_report(user)
            elif path == '/api/admin/users/reset-password' and method == 'POST':
                self.api_admin_reset_password(user)
            
            else:
                self.send_json({'error': 'Endpoint not found'}, 404)
    
    # ========== API METHODS ==========
    def api_login(self):
        try:
            data = self.read_json()
            username = data.get('username', '').strip()
            password = data.get('password', '').strip()
            
            if not username or not password:
                self.send_json({'error': 'Username and password are required'}, 400)
                return
            
            user = self.db.get_user_by_username(username)
            
            if user and user['password_hash'] == hashlib.sha256(password.encode()).hexdigest():
                # Update last login
                self.db.update_last_login(user['id'])
                
                # Create session
                session_id = self.generate_session_id()
                self.sessions[session_id] = {
                    'user': {
                        'id': user['id'],
                        'username': user['username'],
                        'email': user['email'],
                        'full_name': user['full_name'],
                        'city': user.get('city', ''),
                        'is_admin': bool(user['is_admin'])
                    },
                    'expires': datetime.now() + timedelta(hours=2)
                }
                
                self.send_json({
                    'success': True,
                    'user': self.sessions[session_id]['user'],
                    'session_id': session_id
                })
            else:
                self.send_json({'error': 'Invalid username or password'}, 401)
        except Exception as e:
            print(f"Login error: {e}")
            self.send_json({'error': f'Login error: {str(e)}'}, 500)
    
    def api_register(self):
        try:
            data = self.read_json()
            username = data.get('username', '').strip()
            email = data.get('email', '').strip()
            password = data.get('password', '').strip()
            full_name = data.get('full_name', '').strip()
            
            if not username or not email or not password:
                self.send_json({'error': 'Username, email, and password are required'}, 400)
                return
            
            if len(password) < 6:
                self.send_json({'error': 'Password must be at least 6 characters'}, 400)
                return
            
            # Check if username exists
            if self.db.get_user_by_username(username):
                self.send_json({'error': 'Username already exists'}, 400)
                return
            
            # Create user
            password_hash = hashlib.sha256(password.encode()).hexdigest()
            user_id = self.db.create_user(username, email, password_hash, full_name)
            
            if not user_id:
                self.send_json({'error': 'Failed to create user'}, 500)
                return
            
            # Create session
            session_id = self.generate_session_id()
            user_data = {
                'id': user_id,
                'username': username,
                'email': email,
                'full_name': full_name,
                'city': '',
                'is_admin': False
            }
            
            self.sessions[session_id] = {
                'user': user_data,
                'expires': datetime.now() + timedelta(hours=2)
            }
            
            self.send_json({
                'success': True,
                'user': user_data,
                'session_id': session_id
            })
        except Exception as e:
            print(f"Registration error: {e}")
            self.send_json({'error': f'Registration error: {str(e)}'}, 500)
    
    def api_logout(self):
        try:
            cookie = self.headers.get('Cookie', '')
            session_id = None
            
            for part in cookie.split(';'):
                part = part.strip()
                if part.startswith('session_id='):
                    session_id = part.split('=')[1].strip()
                    break
            
            if session_id and session_id in self.sessions:
                del self.sessions[session_id]
            
            self.send_json({'success': True})
        except Exception as e:
            print(f"Logout error: {e}")
            self.send_json({'error': f'Logout error: {str(e)}'}, 500)
    
    def api_user_profile(self, user):
        self.send_json({'user': user})
    
    def api_update_profile(self, user):
        try:
            data = self.read_json()
            # In a real app, you would update the user profile in the database
            self.send_json({'success': True, 'message': 'Profile updated'})
        except Exception as e:
            print(f"Update profile error: {e}")
            self.send_json({'error': f'Update error: {str(e)}'}, 500)
    
    def api_change_password(self, user):
        """Change user password"""
        try:
            data = self.read_json()
            current_password = data.get('current_password', '').strip()
            new_password = data.get('new_password', '').strip()
            
            if not current_password or not new_password:
                self.send_json({'error': 'Current password and new password are required'}, 400)
                return
            
            if len(new_password) < 6:
                self.send_json({'error': 'New password must be at least 6 characters'}, 400)
                return
            
            # Verify current password
            db_user = self.db.get_user_by_id(user['id'])
            if db_user['password_hash'] != hashlib.sha256(current_password.encode()).hexdigest():
                self.send_json({'error': 'Current password is incorrect'}, 400)
                return
            
            # Update password
            new_password_hash = hashlib.sha256(new_password.encode()).hexdigest()
            success = self.db.update_user_password(user['id'], new_password_hash)
            
            if success:
                self.send_json({'success': True, 'message': 'Password changed successfully'})
            else:
                self.send_json({'error': 'Failed to change password'}, 500)
                
        except Exception as e:
            print(f"Password change error: {e}")
            self.send_json({'error': f'Password change error: {str(e)}'}, 500)
    
    def api_get_categories(self):
        try:
            categories = self.db.get_all_categories()
            self.send_json({'categories': categories})
        except Exception as e:
            print(f"Categories error: {e}")
            self.send_json({'error': f'Categories error: {str(e)}'}, 500)
    
    def api_public_stats(self):
        try:
            stats = self.db.get_statistics()
            self.send_json({'stats': stats})
        except Exception as e:
            print(f"Stats error: {e}")
            self.send_json({'error': f'Stats error: {str(e)}'}, 500)
    
    def api_get_reports(self, user):
        try:
            reports = self.db.get_all_reports(user['id'])
            self.send_json({'reports': reports})
        except Exception as e:
            print(f"Reports error: {e}")
            self.send_json({'error': f'Reports error: {str(e)}'}, 500)
    
    def api_create_report(self, user):
        try:
            data = self.read_json()
            
            required_fields = ['location_name', 'description', 'category_id']
            for field in required_fields:
                if field not in data:
                    self.send_json({'error': f'{field} is required'}, 400)
                    return
            
            report_id = self.db.create_waste_report(
                user_id=user['id'],
                category_id=data['category_id'],
                location_name=data['location_name'],
                description=data['description'],
                urgency=data.get('urgency', 'medium'),
                address=data.get('address', '')
            )
            
            self.send_json({'success': True, 'report_id': report_id})
        except Exception as e:
            print(f"Create report error: {e}")
            self.send_json({'error': f'Create report error: {str(e)}'}, 500)
    
    def api_get_report(self, report_id, user):
        try:
            report = self.db.get_report_by_id(report_id, user['id'])
            if not report:
                self.send_json({'error': 'Report not found or access denied'}, 404)
                return
            
            self.send_json({'report': report})
        except Exception as e:
            print(f"Get report error: {e}")
            self.send_json({'error': f'Get report error: {str(e)}'}, 500)
    
    def api_update_report(self, report_id, user):
        try:
            data = self.read_json()
            
            if 'status' in data:
                success = self.db.update_report_status(
                    report_id=report_id,
                    new_status=data['status'],
                    changed_by=user['id'],
                    notes=data.get('notes', '')
                )
                if success:
                    self.send_json({'success': True})
                else:
                    self.send_json({'error': 'Failed to update report'}, 400)
            else:
                self.send_json({'error': 'No update data provided'}, 400)
        except Exception as e:
            print(f"Update report error: {e}")
            self.send_json({'error': f'Update report error: {str(e)}'}, 500)
    
    def api_delete_report(self, report_id, user):
        try:
            success = self.db.delete_report(report_id, user['id'])
            if success:
                self.send_json({'success': True})
            else:
                self.send_json({'error': 'Failed to delete report or access denied'}, 403)
        except Exception as e:
            print(f"Delete report error: {e}")
            self.send_json({'error': f'Delete report error: {str(e)}'}, 500)
    
    def api_get_schedules(self, user):
        try:
            if user['is_admin']:
                schedules = self.db.get_todays_schedules()
            else:
                # For regular users, show their scheduled collections
                schedules = self.db.get_my_schedules(user['id'])
            self.send_json({'schedules': schedules})
        except Exception as e:
            print(f"Schedules error: {e}")
            self.send_json({'error': f'Schedules error: {str(e)}'}, 500)
    
    def api_get_my_schedules(self, user):
        """Get schedules assigned to the current user"""
        try:
            schedules = self.db.get_my_schedules(user['id'])
            self.send_json({'schedules': schedules})
        except Exception as e:
            print(f"My schedules error: {e}")
            self.send_json({'error': f'My schedules error: {str(e)}'}, 500)
    
    def api_create_schedule(self, user):
        try:
            if not user['is_admin']:
                self.send_json({'error': 'Admin access required'}, 403)
                return
            
            data = self.read_json()
            schedule_id = self.db.create_schedule(
                report_id=data['report_id'],
                scheduled_date=data['scheduled_date'],
                scheduled_time=data.get('scheduled_time'),
                assigned_to=data.get('assigned_to'),
                notes=data.get('notes', '')
            )
            
            self.send_json({'success': True, 'schedule_id': schedule_id})
        except Exception as e:
            print(f"Create schedule error: {e}")
            self.send_json({'error': f'Create schedule error: {str(e)}'}, 500)
    
    def api_update_schedule(self, schedule_id, user):
        try:
            data = self.read_json()
            if 'status' in data:
                completed_at = datetime.now().isoformat() if data['status'] == 'completed' else None
                success = self.db.update_schedule_status(schedule_id, data['status'], completed_at)
                if success:
                    self.send_json({'success': True})
                else:
                    self.send_json({'error': 'Failed to update schedule'}, 400)
        except Exception as e:
            print(f"Update schedule error: {e}")
            self.send_json({'error': f'Update schedule error: {str(e)}'}, 500)
    
    def api_admin_stats(self, user):
        try:
            if not user['is_admin']:
                self.send_json({'error': 'Admin access required'}, 403)
                return
            
            stats = self.db.get_statistics()
            self.send_json({'stats': stats})
        except Exception as e:
            print(f"Admin stats error: {e}")
            self.send_json({'error': f'Admin stats error: {str(e)}'}, 500)
    
    def api_get_users(self, user):
        try:
            if not user['is_admin']:
                self.send_json({'error': 'Admin access required'}, 403)
                return
            
            users = self.db.get_all_users(exclude_admin=True)
            self.send_json({'users': users})
        except Exception as e:
            print(f"Users error: {e}")
            self.send_json({'error': f'Users error: {str(e)}'}, 500)
    
    def api_admin_reports(self, user):
        """Get all reports for admin with filtering options"""
        try:
            if not user['is_admin']:
                self.send_json({'error': 'Admin access required'}, 403)
                return
            
            # Get query parameters for filtering
            query_components = parse_qs(urlparse(self.path).query)
            
            status = query_components.get('status', [None])[0]
            category_id = query_components.get('category', [None])[0]
            assigned_to = query_components.get('assigned_to', [None])[0]
            
            reports = self.db.get_all_reports(
                user_id=user['id'], 
                status=status, 
                category_id=category_id,
                assigned_to=assigned_to
            )
            
            # Get collection staff for assignment dropdown
            staff = self.db.get_collection_staff()
            
            self.send_json({'reports': reports, 'collection_staff': staff})
        except Exception as e:
            print(f"Admin reports error: {e}")
            self.send_json({'error': f'Admin reports error: {str(e)}'}, 500)
    
    def api_assign_report(self, user):
        """Admin assigns report to collector"""
        try:
            if not user['is_admin']:
                self.send_json({'error': 'Admin access required'}, 403)
                return
            
            data = self.read_json()
            report_id = data.get('report_id')
            assigned_to = data.get('assigned_to')
            scheduled_date = data.get('scheduled_date')
            scheduled_time = data.get('scheduled_time')
            notes = data.get('notes', '')
            
            if not all([report_id, assigned_to, scheduled_date]):
                self.send_json({'error': 'Report ID, assigned collector, and scheduled date are required'}, 400)
                return
            
            success = self.db.assign_report_to_collector(
                report_id=report_id,
                assigned_to=assigned_to,
                scheduled_date=scheduled_date,
                scheduled_time=scheduled_time,
                notes=notes
            )
            
            if success:
                self.send_json({'success': True, 'message': 'Report assigned successfully'})
            else:
                self.send_json({'error': 'Failed to assign report'}, 500)
                
        except Exception as e:
            print(f"Assign report error: {e}")
            self.send_json({'error': f'Assign report error: {str(e)}'}, 500)
    
    def api_admin_reset_password(self, user):
        """Admin reset user password"""
        try:
            if not user['is_admin']:
                self.send_json({'error': 'Admin access required'}, 403)
                return
            
            data = self.read_json()
            user_id = data.get('user_id')
            new_password = data.get('new_password')
            
            if not user_id or not new_password:
                self.send_json({'error': 'User ID and new password are required'}, 400)
                return
            
            if len(new_password) < 6:
                self.send_json({'error': 'Password must be at least 6 characters'}, 400)
                return
            
            new_password_hash = hashlib.sha256(new_password.encode()).hexdigest()
            success = self.db.update_user_password(user_id, new_password_hash)
            
            if success:
                self.send_json({'success': True, 'message': 'Password reset successfully'})
            else:
                self.send_json({'error': 'Failed to reset password'}, 500)
                
        except Exception as e:
            print(f"Password reset error: {e}")
            self.send_json({'error': f'Password reset error: {str(e)}'}, 500)
    
    # ========== HELPER METHODS ==========
    def read_json(self):
        """Read JSON from request body"""
        try:
            content_length = int(self.headers.get('Content-Length', 0))
            if content_length == 0:
                return {}
            
            body = self.rfile.read(content_length)
            return json.loads(body.decode('utf-8'))
        except:
            return {}
    
    def send_json(self, data, status=200):
        """Send JSON response"""
        try:
            self.send_response(status)
            self.send_header('Content-Type', 'application/json')
            self.send_header('Access-Control-Allow-Origin', '*')
            response_data = json.dumps(data, default=str)
            self.send_header('Content-Length', str(len(response_data.encode())))
            self.end_headers()
            self.wfile.write(response_data.encode())
        except Exception as e:
            print(f"Send JSON error: {e}")
            self.send_error(500, f"Server error: {str(e)}")
    
    def get_html_content(self, page_name):
        """Return HTML content for each page"""
        pages = {
            'home': self.HOME_HTML,
            'login': self.LOGIN_HTML,
            'register': self.REGISTER_HTML,
            'dashboard': self.DASHBOARD_HTML,
            'report': self.REPORT_HTML,
            'reports_list': self.REPORTS_LIST_HTML,
            'report_details': self.REPORT_DETAILS_HTML,
            'schedules': self.SCHEDULES_HTML,
            'my_schedules': self.MY_SCHEDULES_HTML,
            'admin': self.ADMIN_HTML,
            'admin_reports': self.ADMIN_REPORTS_HTML,
            'admin_users': self.ADMIN_USERS_HTML,
            'admin_assign': self.ADMIN_ASSIGN_HTML,
            'profile': self.PROFILE_HTML,
            'change_password': self.CHANGE_PASSWORD_HTML,
            'about': self.ABOUT_HTML,
            'contact': self.CONTACT_HTML
        }
        return pages.get(page_name, '<h1>Page not found</h1>')

    # ========== EMBEDDED STATIC FILES ==========
    STYLE_CSS = """
    /* Fixed Smart Waste Management Platform - CSS */
    :root {
        --primary: #28a745;
        --primary-dark: #1e7e34;
        --secondary: #6c757d;
        --success: #28a745;
        --info: #17a2b8;
        --warning: #ffc107;
        --danger: #dc3545;
        --light: #f8f9fa;
        --dark: #343a40;
        --white: #ffffff;
        --gray: #6c757d;
        --gray-light: #e9ecef;
        --admin-bg: #e3f2fd;
        --admin-border: #2196f3;
    }
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f5f5f5;
    }
    
    /* Navigation */
    .navbar {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .navbar-brand {
        font-weight: 700;
        font-size: 1.5rem;
    }
    
    .nav-link {
        font-weight: 500;
        transition: color 0.3s;
    }
    
    .nav-link:hover {
        color: rgba(255,255,255,0.8);
    }
    
    /* Hero Section */
    .hero-section {
        background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80');
        background-size: cover;
        background-position: center;
        color: white;
        padding: 100px 0;
        margin-bottom: 60px;
    }
    
    .hero-title {
        font-size: 3.5rem;
        font-weight: 700;
        margin-bottom: 20px;
    }
    
    .hero-subtitle {
        font-size: 1.25rem;
        margin-bottom: 30px;
        opacity: 0.9;
    }
    
    /* Cards */
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        transition: transform 0.3s, box-shadow 0.3s;
        margin-bottom: 20px;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .card-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        border-radius: 10px 10px 0 0 !important;
        padding: 15px 20px;
        font-weight: 600;
    }
    
    .stat-card {
        text-align: center;
        padding: 30px 20px;
        border-radius: 10px;
        color: white;
        margin-bottom: 20px;
    }
    
    .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .stat-card.reported { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .stat-card.collected { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .stat-card.processed { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    
    .stat-card .number {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 10px 0;
    }
    
    .stat-card .label {
        font-size: 1rem;
        opacity: 0.9;
    }
    
    /* Buttons */
    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        border: none;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
    
    /* Forms */
    .form-control, .form-select {
        border: 2px solid #e1e5eb;
        border-radius: 8px;
        padding: 12px 15px;
        transition: all 0.3s;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25);
    }
    
    /* Badges */
    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .status-badge.reported { background-color: #6c757d; color: white; }
    .status-badge.assigned { background-color: #17a2b8; color: white; }
    .status-badge.collected { background-color: #28a745; color: white; }
    .status-badge.processed { background-color: #007bff; color: white; }
    
    .urgency-badge.low { background-color: #28a745; color: white; }
    .urgency-badge.medium { background-color: #ffc107; color: #212529; }
    .urgency-badge.high { background-color: #dc3545; color: white; }
    
    /* Tables */
    .table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 15px;
    }
    
    .table tbody td {
        padding: 15px;
        vertical-align: middle;
        border-color: #e9ecef;
    }
    
    .table tbody tr:hover {
        background-color: rgba(40, 167, 69, 0.05);
    }
    
    /* Footer */
    .footer {
        background: linear-gradient(135deg, #343a40 0%, #212529 100%);
        color: white;
        padding: 50px 0 20px;
        margin-top: 60px;
    }
    
    .footer h5 {
        color: var(--primary);
        margin-bottom: 20px;
    }
    
    .footer a {
        color: rgba(255,255,255,0.7);
        text-decoration: none;
        transition: color 0.3s;
    }
    
    .footer a:hover {
        color: var(--primary);
    }
    
    .copyright {
        border-top: 1px solid rgba(255,255,255,0.1);
        padding-top: 20px;
        margin-top: 30px;
        text-align: center;
        color: rgba(255,255,255,0.5);
        font-size: 0.9rem;
    }
    """
    
    HOME_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto" id="authLinks">
                        <li class="nav-item">
                            <a class="nav-link" href="/login"><i class="fas fa-sign-in-alt me-1"></i>Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/register"><i class="fas fa-user-plus me-1"></i>Register</a>
                        </li>
                    </ul>
                    <ul class="navbar-nav ms-auto" id="userMenu" style="display: none;">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a>
                        </li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="userName"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item admin-only" href="/admin" style="display: none;"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <header class="hero-section">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8">
                        <h1 class="hero-title">Smart Waste Management Platform</h1>
                        <p class="hero-subtitle">Report, track, and manage waste collection efficiently. Join our community to keep our environment clean and green.</p>
                        <div class="mt-4">
                            <a href="/register" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-user-plus me-2"></i>Get Started
                            </a>
                            <a href="/login" class="btn btn-outline-light btn-lg">
                                <i class="fas fa-sign-in-alt me-2"></i>Login
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="container py-5">
            <div class="row mb-5">
                <div class="col-md-4 mb-4">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-map-marker-alt fa-3x text-primary mb-3"></i>
                            <h4>Report Waste</h4>
                            <p>Easily report waste accumulation in your area with location details and photos.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-calendar-check fa-3x text-success mb-3"></i>
                            <h4>Track Collection</h4>
                            <p>Monitor the status of your waste reports and view collection schedules.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-chart-line fa-3x text-info mb-3"></i>
                            <h4>Analytics Dashboard</h4>
                            <p>View statistics and insights about waste collection in your community.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">System Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div id="statsContainer">
                                <p class="text-center">Loading statistics...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <a href="/report" class="btn btn-primary w-100">
                                        <i class="fas fa-plus me-2"></i>Report Waste
                                    </a>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <a href="/login" class="btn btn-outline-primary w-100">
                                        <i class="fas fa-sign-in-alt me-2"></i>Login
                                    </a>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <a href="/register" class="btn btn-success w-100">
                                        <i class="fas fa-user-plus me-2"></i>Register
                                    </a>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <a href="/about" class="btn btn-outline-secondary w-100">
                                        <i class="fas fa-info-circle me-2"></i>About Us
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <h5><i class="fas fa-recycle me-2"></i>Smart Waste Management</h5>
                        <p>A platform for efficient waste management and community cleanliness.</p>
                    </div>
                    <div class="col-md-4 mb-4">
                        <h5>Quick Links</h5>
                        <ul class="list-unstyled">
                            <li><a href="/">Home</a></li>
                            <li><a href="/about">About</a></li>
                            <li><a href="/contact">Contact</a></li>
                            <li><a href="/login">Login</a></li>
                            <li><a href="/register">Register</a></li>
                        </ul>
                    </div>
                    <div class="col-md-4 mb-4">
                        <h5>Contact Info</h5>
                        <p><i class="fas fa-envelope me-2"></i>support@smartwaste.com</p>
                        <p><i class="fas fa-phone me-2"></i>+1 (555) 123-4567</p>
                    </div>
                </div>
                <div class="copyright">
                    <p>&copy; 2024 Smart Waste Management. All rights reserved.</p>
                </div>
            </div>
        </footer>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
        <script>
            // Load public stats
            async function loadPublicStats() {
                try {
                    const response = await fetch('/api/stats/public');
                    const data = await response.json();
                    
                    if (data.stats) {
                        const stats = data.stats;
                        const statsHTML = `
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <div class="stat-card total">
                                        <i class="fas fa-trash-alt fa-2x mb-2"></i>
                                        <div class="number">${stats.total_reports}</div>
                                        <div class="label">Total Reports</div>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="stat-card collected">
                                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                                        <div class="number">${stats.collection_rate}%</div>
                                        <div class="label">Collection Rate</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <p><strong>Recent Activity:</strong> ${stats.recent_activity.length} reports in last 7 days</p>
                                <p><strong>Active Users:</strong> ${stats.active_users}</p>
                            </div>
                        `;
                        document.getElementById('statsContainer').innerHTML = statsHTML;
                    }
                } catch (error) {
                    console.error('Failed to load stats:', error);
                    document.getElementById('statsContainer').innerHTML = '<p class="text-danger">Failed to load statistics</p>';
                }
            }
            
            document.addEventListener('DOMContentLoaded', loadPublicStats);
        </script>
    </body>
    </html>
    """
    
    LOGIN_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Login - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
            </div>
        </nav>

        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="card shadow-lg">
                        <div class="card-header">
                            <h4 class="mb-0 text-white"><i class="fas fa-sign-in-alt me-2"></i>Login</h4>
                        </div>
                        <div class="card-body p-4">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username *</label>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password *</label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="remember">
                                    <label class="form-check-label" for="remember">Remember me</label>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login
                                </button>
                            </form>
                            
                            <div class="mt-4 text-center">
                                <p class="mb-2">Don't have an account? 
                                    <a href="/register" class="text-primary">Register here</a>
                                </p>
                                <p class="mb-0">
                                    <a href="/" class="text-muted">
                                        <i class="fas fa-home me-1"></i>Back to Home
                                    </a>
                                </p>
                            </div>
                            
                            <div class="mt-4">
                                <h6 class="text-center">Demo Accounts:</h6>
                                <div class="alert alert-info">
                                    <small>
                                        <strong>Admin:</strong> admin / Admin@2024<br>
                                        <strong>User:</strong> john_doe / User@2024
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </body>
    </html>
    """
    
    REGISTER_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Register - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
            </div>
        </nav>

        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-md-8 col-lg-6">
                    <div class="card shadow-lg">
                        <div class="card-header">
                            <h4 class="mb-0 text-white"><i class="fas fa-user-plus me-2"></i>Create Account</h4>
                        </div>
                        <div class="card-body p-4">
                            <form id="registerForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="username" class="form-label">Username *</label>
                                        <input type="text" class="form-control" id="username" name="username" required>
                                        <small class="text-muted">Choose a unique username</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label">Email *</label>
                                        <input type="email" class="form-control" id="email" name="email" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="full_name" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="full_name" name="full_name">
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="password" class="form-label">Password *</label>
                                        <input type="password" class="form-control" id="password" name="password" required>
                                        <small class="text-muted">Minimum 6 characters</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="confirm_password" class="form-label">Confirm Password *</label>
                                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="terms" required>
                                        <label class="form-check-label" for="terms">
                                            I agree to the <a href="#" class="text-primary">Terms of Service</a> and 
                                            <a href="#" class="text-primary">Privacy Policy</a>
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-user-plus me-2"></i>Create Account
                                </button>
                            </form>
                            
                            <div class="mt-4 text-center">
                                <p class="mb-0">Already have an account? 
                                    <a href="/login" class="text-primary">Login here</a>
                                </p>
                                <a href="/" class="btn btn-outline-secondary btn-sm mt-3">
                                    <i class="fas fa-home me-1"></i>Back to Home
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </body>
    </html>
    """
    
    DASHBOARD_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link active" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                        <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                        <li class="nav-item"><a class="nav-link" href="/my-schedules"><i class="fas fa-calendar-alt me-1"></i>My Schedules</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="userName"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item admin-only" href="/admin" style="display: none;"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <h2 class="mb-4"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
            
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stat-card total">
                        <i class="fas fa-trash-alt fa-2x mb-2"></i>
                        <div class="number" id="totalReports">0</div>
                        <div class="label">Total Reports</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card reported">
                        <i class="fas fa-flag fa-2x mb-2"></i>
                        <div class="number" id="reportedCount">0</div>
                        <div class="label">Reported</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card collected">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <div class="number" id="collectedCount">0</div>
                        <div class="label">Collected</div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stat-card processed">
                        <i class="fas fa-recycle fa-2x mb-2"></i>
                        <div class="number" id="processedCount">0</div>
                        <div class="label">Processed</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Reports</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Location</th>
                                            <th>Category</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportsTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center">Loading reports...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-3">
                                <a href="/reports" class="btn btn-outline-primary">View All Reports</a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="/report" class="btn btn-primary">
                                    <i class="fas fa-plus-circle me-2"></i>New Waste Report
                                </a>
                                <a href="/reports" class="btn btn-outline-primary">
                                    <i class="fas fa-list me-2"></i>View My Reports
                                </a>
                                <a href="/my-schedules" class="btn btn-outline-success">
                                    <i class="fas fa-calendar-alt me-2"></i>My Schedules
                                </a>
                                <a href="/profile" class="btn btn-outline-secondary">
                                    <i class="fas fa-user me-2"></i>My Profile
                                </a>
                                <a href="/admin" class="btn btn-outline-warning admin-only" style="display: none;">
                                    <i class="fas fa-cog me-2"></i>Admin Panel
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0">Upcoming Collections</h5>
                        </div>
                        <div class="card-body">
                            <div id="upcomingSchedules">
                                <p class="text-center">Loading schedules...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
        <script>
            async function loadDashboardData() {
                try {
                    // Load reports
                    const reportsResponse = await fetch('/api/reports');
                    const reportsData = await reportsResponse.json();
                    
                    if (reportsData.reports) {
                        const reports = reportsData.reports;
                        
                        // Update stats
                        document.getElementById('totalReports').textContent = reports.length;
                        
                        const statusCounts = {
                            'reported': 0,
                            'assigned': 0,
                            'collected': 0,
                            'processed': 0
                        };
                        
                        reports.forEach(report => {
                            statusCounts[report.status] = (statusCounts[report.status] || 0) + 1;
                        });
                        
                        document.getElementById('reportedCount').textContent = statusCounts.reported;
                        document.getElementById('collectedCount').textContent = statusCounts.collected;
                        document.getElementById('processedCount').textContent = statusCounts.processed;
                        
                        // Update table
                        const tableBody = document.getElementById('reportsTableBody');
                        if (reports.length === 0) {
                            tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No reports found</td></tr>';
                        } else {
                            const recentReports = reports.slice(0, 5);
                            tableBody.innerHTML = recentReports.map(report => `
                                <tr>
                                    <td>#${report.id}</td>
                                    <td>${report.location_name}</td>
                                    <td>${report.icon} ${report.category_name}</td>
                                    <td>${window.app.getStatusBadge(report.status)}</td>
                                    <td>${window.app.formatDate(report.created_at)}</td>
                                    <td>
                                        <a href="/report-details?id=${report.id}" class="btn btn-sm btn-primary">View</a>
                                    </td>
                                </tr>
                            `).join('');
                        }
                    }
                    
                    // Load schedules
                    const schedulesResponse = await fetch('/api/my-schedules');
                    const schedulesData = await schedulesResponse.json();
                    
                    if (schedulesData.schedules) {
                        const schedules = schedulesData.schedules.slice(0, 3);
                        const schedulesContainer = document.getElementById('upcomingSchedules');
                        
                        if (schedules.length === 0) {
                            schedulesContainer.innerHTML = '<p class="text-center">No upcoming collections</p>';
                        } else {
                            schedulesContainer.innerHTML = schedules.map(schedule => `
                                <div class="mb-3 p-2 border rounded">
                                    <div class="d-flex justify-content-between">
                                        <strong>${schedule.location_name}</strong>
                                        <span class="badge ${schedule.status === 'pending' ? 'bg-warning' : 'bg-info'}">
                                            ${schedule.status}
                                        </span>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>${schedule.scheduled_date}
                                        ${schedule.scheduled_time ? `<br><i class="fas fa-clock me-1"></i>${schedule.scheduled_time}` : ''}
                                    </small>
                                </div>
                            `).join('');
                        }
                    }
                } catch (error) {
                    console.error('Failed to load dashboard data:', error);
                    document.getElementById('reportsTableBody').innerHTML = 
                        '<tr><td colspan="6" class="text-center text-danger">Failed to load data</td></tr>';
                }
            }
            
            document.addEventListener('DOMContentLoaded', () => {
                window.app.init();
                loadDashboardData();
            });
        </script>
    </body>
    </html>
    """
    
    REPORT_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>New Report - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                        <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="userName"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item admin-only" href="/admin" style="display: none;"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card shadow-lg">
                        <div class="card-header">
                            <h4 class="mb-0 text-white"><i class="fas fa-plus-circle me-2"></i>New Waste Report</h4>
                        </div>
                        <div class="card-body p-4">
                            <form id="reportForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="location_name" class="form-label">Location Name *</label>
                                        <input type="text" class="form-control" id="location_name" name="location_name" required placeholder="e.g., Central Park, Main Street">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="category_id" class="form-label">Waste Category *</label>
                                        <select class="form-select category-select" id="category_id" name="category_id" required>
                                            <option value="">Select Category</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address" placeholder="Street address, city, zip code">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description *</label>
                                    <textarea class="form-control" id="description" name="description" rows="4" required placeholder="Describe the waste problem..."></textarea>
                                    <small class="text-muted">Please provide details about the waste (type, quantity, any hazards, etc.)</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="urgency" class="form-label">Urgency Level</label>
                                    <select class="form-select" id="urgency" name="urgency">
                                        <option value="low">Low - Minor issue</option>
                                        <option value="medium" selected>Medium - Standard priority</option>
                                        <option value="high">High - Urgent attention needed</option>
                                    </select>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-2"></i>Submit Report
                                    </button>
                                    <a href="/dashboard" class="btn btn-outline-secondary">Cancel</a>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Reporting Guidelines</h5>
                        </div>
                        <div class="card-body">
                            <ul>
                                <li>Provide accurate location details to help collection teams</li>
                                <li>Select the appropriate waste category for proper handling</li>
                                <li>Use High urgency for hazardous or time-sensitive situations</li>
                                <li>Reports are typically addressed within 24-48 hours</li>
                                <li>You can track your report status in "My Reports" section</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
    </body>
    </html>
    """
    
    REPORTS_LIST_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>My Reports - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                        <li class="nav-item"><a class="nav-link active" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="userName"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item admin-only" href="/admin" style="display: none;"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <h2 class="mb-4"><i class="fas fa-list me-2"></i>My Waste Reports</h2>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchReports" placeholder="Search reports...">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <a href="/report" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-2"></i>New Report
                    </a>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Location</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Urgency</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reportsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center">Loading reports...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
        <script>
            async function loadReports() {
                try {
                    const response = await fetch('/api/reports');
                    const data = await response.json();
                    
                    const tableBody = document.getElementById('reportsTableBody');
                    if (data.reports && data.reports.length > 0) {
                        tableBody.innerHTML = data.reports.map(report => `
                            <tr>
                                <td>#${report.id}</td>
                                <td>
                                    <strong>${report.location_name}</strong>
                                    ${report.address ? `<br><small class="text-muted">${report.address}</small>` : ''}
                                </td>
                                <td>${report.icon} ${report.category_name}</td>
                                <td>${window.app.getStatusBadge(report.status)}</td>
                                <td>${window.app.getUrgencyBadge(report.urgency)}</td>
                                <td>${window.app.formatDate(report.created_at)}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="/report-details?id=${report.id}" class="btn btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        ${report.status === 'reported' ? `
                                        <button class="btn btn-outline-danger" onclick="deleteReport(${report.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="py-4">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <h5>No Reports Found</h5>
                                        <p class="text-muted">You haven't submitted any waste reports yet.</p>
                                        <a href="/report" class="btn btn-primary mt-2">
                                            <i class="fas fa-plus-circle me-2"></i>Create Your First Report
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                } catch (error) {
                    console.error('Failed to load reports:', error);
                    document.getElementById('reportsTableBody').innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Failed to load reports. Please try again.
                            </td>
                        </tr>
                    `;
                }
            }
            
            async function deleteReport(reportId) {
                if (confirm('Are you sure you want to delete this report?')) {
                    try {
                        const response = await fetch(`/api/reports/${reportId}`, {
                            method: 'DELETE'
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('Report deleted successfully!');
                            loadReports();
                        } else {
                            alert(data.error || 'Failed to delete report');
                        }
                    } catch (error) {
                        alert('Error deleting report: ' + error.message);
                    }
                }
            }
            
            document.addEventListener('DOMContentLoaded', () => {
                window.app.init();
                loadReports();
            });
        </script>
    </body>
    </html>
    """
    
    REPORT_DETAILS_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Report Details - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                        <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="userName"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item admin-only" href="/admin" style="display: none;"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <a href="/reports" class="btn btn-outline-secondary mb-4">
                <i class="fas fa-arrow-left me-2"></i>Back to Reports
            </a>
            
            <div id="reportDetails">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading report details...</p>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
        <script>
            async function loadReportDetails() {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const reportId = urlParams.get('id');
                    
                    if (!reportId) {
                        document.getElementById('reportDetails').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                No report ID specified
                            </div>
                        `;
                        return;
                    }
                    
                    const response = await fetch(`/api/reports/${reportId}`);
                    const data = await response.json();
                    
                    if (!data.report) {
                        document.getElementById('reportDetails').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Report not found or access denied
                            </div>
                        `;
                        return;
                    }
                    
                    const report = data.report;
                    
                    document.getElementById('reportDetails').innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h4 class="mb-0">Report #${report.id}</h4>
                                    <div>
                                        ${window.app.getStatusBadge(report.status)}
                                        ${window.app.getUrgencyBadge(report.urgency)}
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-info-circle me-2"></i>Report Information</h5>
                                        <table class="table table-sm">
                                            <tr>
                                                <th width="40%">Location:</th>
                                                <td>${report.location_name}</td>
                                            </tr>
                                            <tr>
                                                <th>Category:</th>
                                                <td>${report.icon} ${report.category_name}</td>
                                            </tr>
                                            <tr>
                                                <th>Address:</th>
                                                <td>${report.address || 'Not specified'}</td>
                                            </tr>
                                            <tr>
                                                <th>Submitted By:</th>
                                                <td>${report.full_name} (${report.username})</td>
                                            </tr>
                                            <tr>
                                                <th>Submitted On:</th>
                                                <td>${window.app.formatDate(report.created_at)}</td>
                                            </tr>
                                            <tr>
                                                <th>Last Updated:</th>
                                                <td>${window.app.formatDate(report.updated_at)}</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h5><i class="fas fa-align-left me-2"></i>Description</h5>
                                        <div class="p-3 bg-light rounded">
                                            ${report.description}
                                        </div>
                                    </div>
                                </div>
                                
                                ${report.schedules && report.schedules.length > 0 ? `
                                <div class="mt-4">
                                    <h5><i class="fas fa-calendar-alt me-2"></i>Collection Schedules</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Scheduled Date</th>
                                                    <th>Time</th>
                                                    <th>Assigned To</th>
                                                    <th>Status</th>
                                                    <th>Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${report.schedules.map(schedule => `
                                                    <tr>
                                                        <td>${schedule.scheduled_date}</td>
                                                        <td>${schedule.scheduled_time || '-'}</td>
                                                        <td>${schedule.assigned_to_name || 'Not assigned'}</td>
                                                        <td>
                                                            <span class="badge ${schedule.status === 'completed' ? 'bg-success' : schedule.status === 'in_progress' ? 'bg-info' : 'bg-warning'}">
                                                                ${schedule.status}
                                                            </span>
                                                        </td>
                                                        <td>${schedule.notes || '-'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${report.history && report.history.length > 0 ? `
                                <div class="mt-4">
                                    <h5><i class="fas fa-history me-2"></i>Status History</h5>
                                    <div class="timeline">
                                        ${report.history.map(history => `
                                            <div class="timeline-item mb-3">
                                                <div class="d-flex">
                                                    <div class="timeline-marker"></div>
                                                    <div class="ms-3">
                                                        <div class="d-flex justify-content-between">
                                                            <strong>${history.new_status}</strong>
                                                            <small class="text-muted">${window.app.formatDate(history.changed_at)}</small>
                                                        </div>
                                                        ${history.notes ? `<small class="text-muted">${history.notes}</small><br>` : ''}
                                                        <small>Changed by: ${history.changed_by_name || 'System'}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Failed to load report details:', error);
                    document.getElementById('reportDetails').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load report details: ${error.message}
                        </div>
                    `;
                }
            }
            
            document.addEventListener('DOMContentLoaded', () => {
                window.app.init();
                loadReportDetails();
            });
        </script>
        <style>
            .timeline {
                position: relative;
                padding-left: 20px;
            }
            .timeline-item {
                position: relative;
            }
            .timeline-marker {
                position: absolute;
                left: -20px;
                top: 6px;
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background-color: #28a745;
            }
        </style>
    </body>
    </html>
    """
    
    CHANGE_PASSWORD_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Change Password - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                        <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="userName"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item active" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item admin-only" href="/admin" style="display: none;"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow-lg">
                        <div class="card-header">
                            <h4 class="mb-0 text-white"><i class="fas fa-key me-2"></i>Change Password</h4>
                        </div>
                        <div class="card-body p-4">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="current_password" class="form-label">Current Password *</label>
                                    <input type="password" class="form-control" id="current_password" name="current_password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="new_password" class="form-label">New Password *</label>
                                    <input type="password" class="form-control" id="new_password" name="new_password" required>
                                    <small class="text-muted">Minimum 6 characters</small>
                                </div>
                                <div class="mb-3">
                                    <label for="confirm_password" class="form-label">Confirm New Password *</label>
                                    <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-save me-2"></i>Change Password
                                </button>
                            </form>
                            
                            <div class="mt-4 text-center">
                                <a href="/dashboard" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </body>
    </html>
    """
    
    ADMIN_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Panel - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                        <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="userName"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item active" href="/admin"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <h2 class="mb-4"><i class="fas fa-cog me-2"></i>Admin Panel</h2>
            
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-users fa-3x text-primary mb-3"></i>
                            <h5>User Management</h5>
                            <p>Manage system users, reset passwords, and view user activity.</p>
                            <a href="/admin/users" class="btn btn-primary">Manage Users</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-chart-bar fa-3x text-success mb-3"></i>
                            <h5>Reports Management</h5>
                            <p>View all waste reports, update status, and assign to collectors.</p>
                            <a href="/admin/reports" class="btn btn-success">View Reports</a>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card text-center h-100">
                        <div class="card-body">
                            <i class="fas fa-tasks fa-3x text-info mb-3"></i>
                            <h5>Assignments</h5>
                            <p>Assign collection tasks to staff and schedule pickups.</p>
                            <a href="/admin/assign" class="btn btn-info">Assign Tasks</a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">System Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div id="adminStats">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="viewTodaysSchedules()">
                                    <i class="fas fa-calendar-day me-2"></i>Today's Schedules
                                </button>
                                <button class="btn btn-outline-success" onclick="viewPendingReports()">
                                    <i class="fas fa-clock me-2"></i>Pending Reports
                                </button>
                                <button class="btn btn-outline-warning" onclick="refreshStats()">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh Statistics
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
        <script>
            async function loadAdminStats() {
                try {
                    const response = await fetch('/api/admin/stats');
                    const data = await response.json();
                    
                    if (data.stats) {
                        const stats = data.stats;
                        document.getElementById('adminStats').innerHTML = `
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <div class="text-center">
                                        <h3>${stats.total_reports}</h3>
                                        <small>Total Reports</small>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="text-center">
                                        <h3>${stats.total_users}</h3>
                                        <small>Total Users</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <div class="text-center">
                                        <h3>${stats.collection_rate}%</h3>
                                        <small>Collection Rate</small>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="text-center">
                                        <h3>${stats.active_users}</h3>
                                        <small>Active Users</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Report Status Distribution:</h6>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-secondary" style="width: ${(stats.by_status?.reported || 0) / stats.total_reports * 100}%">
                                        Reported: ${stats.by_status?.reported || 0}
                                    </div>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-info" style="width: ${(stats.by_status?.assigned || 0) / stats.total_reports * 100}%">
                                        Assigned: ${stats.by_status?.assigned || 0}
                                    </div>
                                </div>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success" style="width: ${(stats.by_status?.collected || 0) / stats.total_reports * 100}%">
                                        Collected: ${stats.by_status?.collected || 0}
                                    </div>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-primary" style="width: ${(stats.by_status?.processed || 0) / stats.total_reports * 100}%">
                                        Processed: ${stats.by_status?.processed || 0}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Failed to load admin stats:', error);
                    document.getElementById('adminStats').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load statistics
                        </div>
                    `;
                }
            }
            
            function viewTodaysSchedules() {
                alert('Redirecting to today\'s schedules...');
                // In a real app, you would redirect to schedules page filtered for today
            }
            
            function viewPendingReports() {
                window.location.href = '/admin/reports?status=reported';
            }
            
            function refreshStats() {
                document.getElementById('adminStats').innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                loadAdminStats();
            }
            
            document.addEventListener('DOMContentLoaded', () => {
                window.app.init();
                loadAdminStats();
            });
        </script>
    </body>
    </html>
    """
    
    # Add remaining pages with navigation
    SCHEDULES_HTML = """
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedules - Smart Waste Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-recycle me-2"></i>
                Smart Waste Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                    <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/schedules"><i class="fas fa-calendar-alt me-1"></i>Schedules</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item admin-only" href="/admin" style="display: none;"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <h2 class="mb-4"><i class="fas fa-calendar-alt me-2"></i>Collection Schedules</h2>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Today's Collection Schedules</h5>
            </div>
            <div class="card-body">
                <div id="schedulesTableBody">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading schedules...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/script.js"></script>
    <script>
        async function loadSchedules() {
            try {
                const response = await fetch('/api/schedules');
                const data = await response.json();
                
                const container = document.getElementById('schedulesTableBody');
                if (data.schedules && data.schedules.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Report ID</th>
                                        <th>Location</th>
                                        <th>Category</th>
                                        <th>Date & Time</th>
                                        <th>Assigned To</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.schedules.map(schedule => `
                                        <tr>
                                            <td>#${schedule.report_id}</td>
                                            <td>${schedule.location_name}</td>
                                            <td>${schedule.category_name}</td>
                                            <td>
                                                ${schedule.scheduled_date}
                                                ${schedule.scheduled_time ? `<br><small>${schedule.scheduled_time}</small>` : ''}
                                            </td>
                                            <td>${schedule.assigned_to_name || 'Not assigned'}</td>
                                            <td>
                                                <span class="badge ${schedule.status === 'completed' ? 'bg-success' : schedule.status === 'in_progress' ? 'bg-info' : 'bg-warning'}">
                                                    ${schedule.status}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-success" onclick="updateScheduleStatus(${schedule.id}, 'completed')">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-outline-info" onclick="updateScheduleStatus(${schedule.id}, 'in_progress')">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <h5>No Schedules Today</h5>
                            <p class="text-muted">There are no collection schedules for today.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load schedules:', error);
                document.getElementById('schedulesTableBody').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load schedules: ${error.message}
                    </div>
                `;
            }
        }
        
        async function updateScheduleStatus(scheduleId, status) {
            if (!confirm(`Mark this schedule as ${status}?`)) return;
            
            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Schedule updated successfully!');
                    loadSchedules();
                } else {
                    alert(data.error || 'Failed to update schedule');
                }
            } catch (error) {
                alert('Error updating schedule: ' + error.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            window.app.init();
            loadSchedules();
        });
    </script>
</body>
</html>
    """
    
    MY_SCHEDULES_HTML = """
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Schedules - Smart Waste Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-recycle me-2"></i>
                Smart Waste Management
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                    <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/my-schedules"><i class="fas fa-tasks me-1"></i>My Schedules</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="userName"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item admin-only" href="/admin" style="display: none;"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <h2 class="mb-4"><i class="fas fa-tasks me-2"></i>My Collection Schedules</h2>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Assigned Collection Tasks</h5>
            </div>
            <div class="card-body">
                <div id="mySchedulesContainer">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading your schedules...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/script.js"></script>
    <script>
        async function loadMySchedules() {
            try {
                const response = await fetch('/api/my-schedules');
                const data = await response.json();
                
                const container = document.getElementById('mySchedulesContainer');
                if (data.schedules && data.schedules.length > 0) {
                    container.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Report ID</th>
                                        <th>Location</th>
                                        <th>Category</th>
                                        <th>Urgency</th>
                                        <th>Date & Time</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.schedules.map(schedule => `
                                        <tr>
                                            <td>#${schedule.report_id}</td>
                                            <td>
                                                <strong>${schedule.location_name}</strong>
                                                ${schedule.description ? `<br><small class="text-muted">${schedule.description.substring(0, 50)}...</small>` : ''}
                                            </td>
                                            <td>${schedule.category_name}</td>
                                            <td>${window.app.getUrgencyBadge(schedule.urgency)}</td>
                                            <td>
                                                ${schedule.scheduled_date}
                                                ${schedule.scheduled_time ? `<br><small>${schedule.scheduled_time}</small>` : ''}
                                            </td>
                                            <td>
                                                <span class="badge ${schedule.status === 'completed' ? 'bg-success' : schedule.status === 'in_progress' ? 'bg-info' : 'bg-warning'}">
                                                    ${schedule.status}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    ${schedule.status !== 'completed' ? `
                                                    <button class="btn btn-outline-success" onclick="updateMySchedule(${schedule.id}, 'completed')">
                                                        <i class="fas fa-check"></i> Complete
                                                    </button>
                                                    <button class="btn btn-outline-info" onclick="updateMySchedule(${schedule.id}, 'in_progress')">
                                                        <i class="fas fa-play"></i> Start
                                                    </button>
                                                    ` : `
                                                    <button class="btn btn-outline-secondary" disabled>
                                                        <i class="fas fa-check-circle"></i> Completed
                                                    </button>
                                                    `}
                                                    <a href="/report-details?id=${schedule.report_id}" class="btn btn-outline-primary">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-clipboard-check fa-3x text-muted mb-3"></i>
                            <h5>No Assigned Tasks</h5>
                            <p class="text-muted">You don't have any collection tasks assigned to you.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load schedules:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load schedules: ${error.message}
                    </div>
                `;
            }
        }
        
        async function updateMySchedule(scheduleId, status) {
            if (!confirm(`Mark this task as ${status}?`)) return;
            
            try {
                const response = await fetch(`/api/schedules/${scheduleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Task updated successfully!');
                    loadMySchedules();
                } else {
                    alert(data.error || 'Failed to update task');
                }
            } catch (error) {
                alert('Error updating task: ' + error.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            window.app.init();
            loadMySchedules();
        });
    </script>
</body>
</html>
    """
    
    # Add remaining admin pages with navigation
    ADMIN_REPORTS_HTML = ADMIN_USERS_HTML = ADMIN_ASSIGN_HTML = PROFILE_HTML = ABOUT_HTML = CONTACT_HTML = """
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Page - Smart Waste Management</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/static/css/style.css">
        <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <i class="fas fa-recycle me-2"></i>
                    Smart Waste Management
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item"><a class="nav-link" href="/dashboard"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/report"><i class="fas fa-plus-circle me-1"></i>New Report</a></li>
                        <li class="nav-item"><a class="nav-link" href="/reports"><i class="fas fa-list me-1"></i>My Reports</a></li>
                        <li class="nav-item"><a class="nav-link" href="/my-schedules"><i class="fas fa-tasks me-1"></i>My Schedules</a></li>
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle me-1"></i>
                                <span id="userName"></span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="/change-password"><i class="fas fa-key me-2"></i>Change Password</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="/admin"><i class="fas fa-cog me-2"></i>Admin Panel</a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container py-5">
            <div class="text-center">
                <i class="fas fa-tools fa-4x text-warning mb-4"></i>
                <h2>Page Under Construction</h2>
                <p class="lead">This page is currently being developed. Please check back later for updates.</p>
                <div class="mt-4">
                    <a href="/dashboard" class="btn btn-primary me-2">
                        <i class="fas fa-tachometer-alt me-2"></i>Back to Dashboard
                    </a>
                    <a href="/" class="btn btn-outline-secondary">
                        <i class="fas fa-home me-2"></i>Go to Home
                    </a>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="/static/js/script.js"></script>
    </body>
    </html>
    """
    
    SCRIPT_JS = """
    // Fixed Smart Waste Management Platform - JavaScript
    class SmartWasteApp {
        constructor() {
            this.currentUser = null;
            this.categories = [];
            this.init();
        }
        
        async init() {
            await this.loadCurrentUser();
            await this.loadCategories();
            this.initEventListeners();
        }
        
        async loadCurrentUser() {
            try {
                const response = await this.apiRequest('/api/user/profile');
                if (response.user) {
                    this.currentUser = response.user;
                    this.updateUIForUser();
                }
            } catch (error) {
                this.currentUser = null;
            }
        }
        
        async loadCategories() {
            try {
                const response = await this.apiRequest('/api/categories');
                this.categories = response.categories || [];
                
                const categorySelects = document.querySelectorAll('.category-select');
                categorySelects.forEach(select => {
                    select.innerHTML = '<option value="">Select Category</option>' +
                        this.categories.map(cat => 
                            `<option value="${cat.id}" data-color="${cat.color_code}" data-icon="${cat.icon}">
                                ${cat.icon} ${cat.name}
                            </option>`
                        ).join('');
                });
            } catch (error) {
                console.error('Failed to load categories:', error);
            }
        }
        
        updateUIForUser() {
            const authLinks = document.getElementById('authLinks');
            const userMenu = document.getElementById('userMenu');
            
            if (this.currentUser) {
                if (authLinks) authLinks.style.display = 'none';
                if (userMenu) {
                    userMenu.style.display = 'block';
                    document.getElementById('userName').textContent = this.currentUser.full_name || this.currentUser.username;
                    
                    const adminLinks = document.querySelectorAll('.admin-only');
                    adminLinks.forEach(link => {
                        link.style.display = this.currentUser.is_admin ? 'block' : 'none';
                    });
                }
            } else {
                if (authLinks) authLinks.style.display = 'block';
                if (userMenu) userMenu.style.display = 'none';
            }
        }
        
        async apiRequest(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(endpoint, options);
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Request failed');
            }
            
            return result;
        }
        
        initEventListeners() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleLogin(e.target);
                });
            }
            
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleRegister(e.target);
                });
            }
            
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleReportSubmit(e.target);
                });
            }
            
            const changePasswordForm = document.getElementById('changePasswordForm');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleChangePassword(e.target);
                });
            }
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    await this.handleLogout();
                });
            }
        }
        
        async handleLogin(form) {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            try {
                const result = await this.apiRequest('/api/login', 'POST', data);
                
                if (result.success) {
                    document.cookie = `session_id=${result.session_id}; path=/`;
                    this.showAlert('Login successful! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1000);
                }
            } catch (error) {
                this.showAlert(error.message || 'Login failed', 'danger');
            }
        }
        
        async handleRegister(form) {
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            if (data.password !== data.confirm_password) {
                this.showAlert('Passwords do not match', 'danger');
                return;
            }
            
            if (data.password.length < 6) {
                this.showAlert('Password must be at least 6 characters', 'danger');
                return;
            }
            
            try {
                const result = await this.apiRequest('/api/register', 'POST', {
                    username: data.username,
                    email: data.email,
                    password: data.password,
                    full_name: data.full_name
                });
                
                if (result.success) {
                    document.cookie = `session_id=${result.session_id}; path=/`;
                    this.showAlert('Registration successful! Welcome!', 'success');
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                }
            } catch (error) {
                this.showAlert(error.message || 'Registration failed', 'danger');
            }
        }
        
        async handleReportSubmit(form) {
            if (!this.currentUser) {
                this.showAlert('Please login to submit a report', 'warning');
                window.location.href = '/login';
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            try {
                const result = await this.apiRequest('/api/reports', 'POST', data);
                
                if (result.success) {
                    this.showAlert('Report submitted successfully!', 'success');
                    form.reset();
                    setTimeout(() => {
                        window.location.href = '/reports';
                    }, 1500);
                }
            } catch (error) {
                this.showAlert(error.message || 'Failed to submit report', 'danger');
            }
        }
        
        async handleChangePassword(form) {
            if (!this.currentUser) {
                this.showAlert('Please login to change password', 'warning');
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            
            if (data.new_password !== data.confirm_password) {
                this.showAlert('New passwords do not match', 'danger');
                return;
            }
            
            if (data.new_password.length < 6) {
                this.showAlert('New password must be at least 6 characters', 'danger');
                return;
            }
            
            try {
                const result = await this.apiRequest('/api/user/change-password', 'POST', {
                    current_password: data.current_password,
                    new_password: data.new_password
                });
                
                if (result.success) {
                    this.showAlert('Password changed successfully!', 'success');
                    form.reset();
                }
            } catch (error) {
                this.showAlert(error.message || 'Failed to change password', 'danger');
            }
        }
        
        async handleLogout() {
            try {
                await this.apiRequest('/api/logout', 'POST');
                document.cookie = 'session_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                window.location.href = '/';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        showAlert(message, type = 'info') {
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const container = document.querySelector('.container') || document.body;
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }
        
        getStatusBadge(status) {
            const badges = {
                'reported': '<span class="badge status-badge reported">Reported</span>',
                'assigned': '<span class="badge status-badge assigned">Assigned</span>',
                'collected': '<span class="badge status-badge collected">Collected</span>',
                'processed': '<span class="badge status-badge processed">Processed</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
        }
        
        getUrgencyBadge(urgency) {
            const badges = {
                'low': '<span class="badge urgency-badge low">Low</span>',
                'medium': '<span class="badge urgency-badge medium">Medium</span>',
                'high': '<span class="badge urgency-badge high">High</span>'
            };
            return badges[urgency] || '<span class="badge bg-secondary">Unknown</span>';
        }
    }
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
        window.app = new SmartWasteApp();
    });
    """
    
    CHART_JS = """
    // Chart.js integration
    let statusChart = null;
    let categoryChart = null;
    let activityChart = null;
    
    function initializeCharts() {
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            statusChart = new Chart(statusCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Reported', 'Assigned', 'Collected', 'Processed'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#6c757d', '#17a2b8', '#28a745', '#007bff'],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
    }
    
    function updateCharts(stats) {
        if (statusChart) {
            statusChart.data.datasets[0].data = [
                stats.by_status?.reported || 0,
                stats.by_status?.assigned || 0,
                stats.by_status?.collected || 0,
                stats.by_status?.processed || 0
            ];
            statusChart.update();
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof Chart !== 'undefined') {
            initializeCharts();
        }
    });
    """

# ============================================
# MAIN EXECUTION
# ============================================
if __name__ == '__main__':
    print("=" * 80)
    print("FIXED SMART WASTE MANAGEMENT WEB PLATFORM")
    print("=" * 80)
    print("Fixed Issues:")
    print("âœ… Added missing create_user method to DatabaseManager")
    print("âœ… Fixed database field mapping for MySQL and SQLite")
    print("âœ… Added proper navigation to all HTML pages")
    print("âœ… Enhanced error handling and debugging")
    print("âœ… Fixed user session management")
    print("âœ… Added complete dashboard functionality")
    print("-" * 80)
    print("Setup Instructions:")
    print("1. Install MySQL: pip install mysql-connector-python (optional)")
    print("2. Run: python smart_waste_platform.py")
    print("3. Access: http://localhost:8080")
    print("-" * 80)
    print("Demo Accounts:")
    print("â€¢ Admin: username 'admin', password 'Admin@2024'")
    print("â€¢ User: username 'john_doe', password 'User@2024'")
    print("=" * 80)
    
    try:
        # Start the server
        server = HTTPServer(('0.0.0.0', 8080), SmartWasteHandler)
        print("ðŸš€ Fixed server started successfully! Press Ctrl+C to stop.")
        print("ðŸŒ Open your browser and go to: http://localhost:8080")
        print("-" * 80)
        server.serve_forever()
    except KeyboardInterrupt:
        print("\nðŸ‘‹ Server stopped. Thank you for using Smart Waste Management!")
    except Exception as e:
        print(f"\nâŒ Error: {e}")
        import traceback
        traceback.print_exc()
